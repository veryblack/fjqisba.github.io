---
layout: post
title: '反调试中特殊的GetCommandLine反调试'
date: 2018-09-19
categories: ollydbg
tags: ollydbg 反调试
---

创建进程有两个重要的参数ModuleFileName和CommandLine,只要不同时为NULL,即可成功创建进程.
调试器创建进程一直都是以命令行的方式进行,然而这样就导致与正常打开进程所生成的命令行不一致.

这就导致可以利用这个BUG,使用GetCommandLine进行检测OD调试器.

例如
某个程序默认打开的命令行如下:
"D:\\test.exe" 

用十六进制形式表示则为
22 44 3A 5C 5C 74 65 73 74 2E 65 78 65 22 20
	
---
那么在调试器内打开，命令行则为:
"D:\\test.exe"

看起来和程序不在调试器内打开的一样是吗?

然而实际上十六进制形式表示则为
22 44 3A 5C 5C 74 65 73 74 2E 65 78 65 22

其实说白了就是利用了命令行后是否有一个空格符来检测是否为反调试....
知道了这个bug就很好处理了,可以定位到OD关键代码处0x00477925,对此处进行patch即可修正此BUG

此外我还对其它调试器进行了测试,发现YZDBG和X32DBG都能被轻易检测到......

但是此反调试兼容性并不是很好,因为有的进程例如通过CMD来打开进程,不带任何参数情况下，ModuleFileName和CommandLine是相同的,而且CommandLine并没有双引号,自然也就不需要空格了.这就会导致误判.......
![坑爹](/assets/img/坑爹.gif)